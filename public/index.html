<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Search สารก่อภูมิแพ้</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Sarabun',sans-serif;background-color:#f0f2f5;color:#333;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;padding-top:2rem;padding-bottom:2rem}
        #app-container{width:90%;max-width:650px;background-color:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        h1{color:#1a73e8;text-align:center;margin-bottom:1.5rem}
        #search-box{width:100%;padding:14px;font-size:1.1rem;border-radius:8px;border:2px solid #ccc;box-sizing:border-box;transition:border-color .3s}
        #search-box:focus{border-color:#1a73e8;outline:none}
        #result-container{margin-top:1.5rem;min-height:50px;line-height:1.7}
        .result-item h4{margin-top:1rem;margin-bottom:.5rem;color:#1a73e8;border-bottom:2px solid #e0e0e0;padding-bottom:.4rem}
        .result-item p{margin:0 0 .5rem .5rem}
        .source-info{font-size:.9rem;font-weight:700;padding:.5rem 1rem;border-radius:6px;margin-bottom:1rem;text-align:center}
        .source-db{background-color:#e6f4ea;color:#1e8e3e;border:1px solid #a8d5b5}
        .source-google{background-color:#fff0e6;color:#d93025;border:1px solid #f5c2b3}
        .source-cache{background-color:#e8f0fe;color:#174ea6;border:1px solid #a9c5f5} /* สีใหม่สำหรับ Cache */
        #ai-search-btn{width:100%;padding:12px;font-size:1.1rem;font-weight:700;color:#fff;background-color:#f29900;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s;margin-top:1rem}
        #ai-search-btn:hover{background-color:#d18400}
        .loader{border:5px solid #f3f3f3;border-top:5px solid #1a73e8;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.delete-cache-btn {background: none;border: 1px solid #d93025;color: #d93025;padding: 4px 8px;font-size: 0.8rem;border-radius: 4px;cursor: pointer;float: right; /* ทำให้ปุ่มไปอยู่ทางขวา */margin-top: -5px;transition: background-color 0.2s, color 0.2s;}
        .delete-cache-btn:hover {background-color: #d93025;color: white;}
        .compare-ai-btn {width: 100%;padding: 10px;font-size: 1rem;font-weight: 700;color: #fff;background-color: #34a853; /* สีเขียว */border: none;border-radius: 8px;cursor: pointer;transition: background-color .3s;margin-top: 1.5rem;}
        .compare-ai-btn:hover {background-color: #1e8e3e;}
        .result-block { /* --- บล็อกสำหรับครอบผลลัพธ์แต่ละส่วน --- */border: 1px solid #e0e0e0;border-radius: 8px;padding: 1.5rem;margin-bottom: 1rem;background-color: #f9f9f9;}
    </style>_
</head>
<body>
    <div id="app-container">
        <h1>ค้นหาสารก่อภูมิแพ้</h1>
        <a href="/list.html" style="display: block; text-align: center; margin-bottom: 1.5rem;">ดูรายการสารทั้งหมด →</a>
        <input type="text" id="search-box" placeholder="เริ่มพิมพ์เพื่อค้นหา...">
        <div id="result-container">
            <p style="text-align:center; color: #555;">ผลการค้นหาจะแสดงที่นี่...</p>
        </div>
    </div>

    <script>
        const searchBox = document.getElementById('search-box');
        const resultContainer = document.getElementById('result-container');
        let debounceTimer;

        const debounce = (func, delay) => {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        };
 // --- ฟังก์ชันใหม่! สำหรับลบ Cache ---
        const deleteCacheAndReset = async (queryToDelete) => {
            try {
                await fetch('/api/delete-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: queryToDelete })
                });
                alert(`ลบ Cache สำหรับ "${queryToDelete}" เรียบร้อยแล้ว`);
                searchBox.value = '';
                resultContainer.innerHTML = '<p style="text-align:center; color: #555;">กรุณาค้นหาอีกครั้ง</p>';
                searchBox.focus();
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการลบ Cache');
            }
        };

        // --- แก้ไขฟังก์ชัน renderResult ให้ถูกต้อง ---
        const renderResult = (data, originalQuery) => {
            let sourceClass = 'source-google';
            let deleteButtonHTML = '';

            if (data.source.includes('ฐานข้อมูลของเรา')) {
                sourceClass = 'source-db';
            } else if (data.source.includes('Cache')) {
                sourceClass = 'source-cache';
                // แก้ไข Syntax ที่ผิด: เพิ่ม {} และใช้ originalQuery ที่ถูกต้อง
                deleteButtonHTML = `<button class="delete-cache-btn" data-query="${originalQuery}">ลบ Cache</button>`;
            }
            let compareButtonHTML = '';
            // ถ้ามาจาก DB หลัก และไม่ใช่การแสดงผลแบบเปรียบเทียบ ให้สร้างปุ่มค้นหาเพิ่มเติม
            if (data.source.includes('ฐานข้อมูลของเรา') && !isComparison) {
                compareButtonHTML = `<button class="compare-ai-btn" data-query="${originalQuery}">ค้นหาข้อมูลเพิ่มเติมด้วย AI (เพื่อเปรียบเทียบ)</button>`;
            }
            
            return `
                <div class="result-block">
                    <div class="source-info ${sourceClass}">
                        ${deleteButtonHTML}
                        <strong>ที่มา:</strong> ${data.source}
                    </div>
                    <div class="result-item">
                        <h4>โอกาสแพ้</h4><p>${data.allergy_status}</p>
                        <h4>ชื่อจริง</h4><p>${data.name}</p>
                        <h4>ชื่อแฝง</h4><p>${data.aliases || '-'}</p>
                        <h4>หน้าที่</h4><p>${data.func || '-'}</p>
                        <h4>พบใน</h4><p>${data.products || '-'}</p>
                    </div>
                    ${compareButtonHTML}
                </div>
            `;
        };
        
        // --- อัปเดตฟังก์ชัน searchWithAI ---
        const searchWithAI = async (question, isForComparison = false) => {
            // สร้าง div ใหม่สำหรับผลลัพธ์จาก AI
            const aiResultContainer = document.createElement('div');
            aiResultContainer.innerHTML = '<div class="loader"></div>';
            
            // ถ้าเป็นการเปรียบเทียบ ให้เอาไปต่อท้าย, ถ้าเป็นการค้นหาปกติ ให้ล้างของเก่า
            if (isForComparison) {
                resultContainer.appendChild(aiResultContainer);
            } else {
                resultContainer.innerHTML = '';
                resultContainer.appendChild(aiResultContainer);
            }

            try {
                const response = await fetch('/api/ask-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'เกิดข้อผิดพลาด');
                
                // สร้างข้อมูล Cache ที่สมบูรณ์
                const finalData = { ...data, source: 'ผลการค้นหาที่ถูกบันทึกไว้ (Cache)', allergy_status: 'ข้อมูลนี้เป็นเพียงสิ่งที่เคยค้นหาและบันทึกไว้' };
                
                // บันทึกลง LocalStorage
                localStorage.setItem(question.toLowerCase().trim(), JSON.stringify(finalData));
                
                // แสดงผลลัพธ์ใน div ของ AI
                aiResultContainer.outerHTML = renderResult(finalData, question, true);

            } catch (error) {
                aiResultContainer.innerHTML = `<div class="result-block"><div class="source-info source-google">เกิดข้อผิดพลาด: ${error.message}</div></div>`;
            } finally {
                if (!isForComparison) {
                    searchBox.value = '';
                }
            }
        };

        // --- อัปเดตฟังก์ชัน handleLiveSearch ---
        const handleLiveSearch = async (question) => {
            currentQuery = question;
            if (question.trim().length < 2) {
                resultContainer.innerHTML = '<p style="text-align:center; color: #555;">กรุณาพิมพ์อย่างน้อย 2 ตัวอักษร...</p>';
                return;
            }

            // --- Logic การค้นหาเหมือนเดิม ---
            const cacheResult = localStorage.getItem(question.toLowerCase().trim());
            if (cacheResult) {
                resultContainer.innerHTML = renderResult(JSON.parse(cacheResult), question);
                return;
            }

            resultContainer.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch('/api/live-search', { /* ... */ });
                const result = await response.json();

                if (result.found) {
                    resultContainer.innerHTML = renderResult(result.data, question);
                } else {
                    resultContainer.innerHTML = `...`; // โค้ดแสดงปุ่มค้นหา AI ปกติ
                    document.getElementById('ai-search-btn').addEventListener('click', () => searchWithAI(question, false));
                }
            } catch (error) { /* ... */ }
        };

        // --- อัปเดต Event Listener ให้รองรับปุ่มใหม่ ---
        resultContainer.addEventListener('click', (event) => {
            // จัดการปุ่มลบ Cache
            if (event.target.classList.contains('delete-cache-btn')) {
                const queryToDelete = event.target.dataset.query;
                if (queryToDelete && confirm(`...`)) {
                    deleteCacheAndReset(queryToDelete);
                }
            }
            // จัดการปุ่มค้นหาเพิ่มเติมด้วย AI
            if (event.target.classList.contains('compare-ai-btn')) {
                const queryToCompare = event.target.dataset.query;
                event.target.disabled = true; // ปิดปุ่มหลังกด
                event.target.textContent = 'กำลังค้นหาด้วย AI...';
                searchWithAI(queryToCompare, true); // เรียกใช้ฟังก์ชัน AI ในโหมดเปรียบเทียบ
            }
        });
        searchBox.addEventListener('input', debounce((e) => handleLiveSearch(e.target.value), 300));
    </script>
</body>
</html>