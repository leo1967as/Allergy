<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นหาสารก่อภูมิแพ้</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Sarabun',sans-serif;background-color:#f0f2f5;color:#333;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;padding:2rem 0}
        #app-container{width:90%;max-width:650px;background-color:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        h1{color:#1a73e8;text-align:center;margin-bottom:1.5rem}
        #search-box{width:100%;padding:14px;font-size:1.1rem;border-radius:8px;border:2px solid #ccc;box-sizing:border-box;transition:border-color .3s}
        #search-box:focus{border-color:#1a73e8;outline:none}
        #result-container{margin-top:1.5rem;min-height:50px;line-height:1.7}
        .result-block{border:1px solid #e0e0e0;border-radius:8px;padding:1.5rem;margin-bottom:1rem;background-color:#f9f9f9}
        .result-item h4{margin-top:1rem;margin-bottom:.5rem;color:#1a73e8;border-bottom:2px solid #e0e0e0;padding-bottom:.4rem}
        .result-item p{margin:0 0 .5rem .5rem;word-wrap:break-word}
        .source-info{font-size:.9rem;font-weight:700;padding:.5rem 1rem;border-radius:6px;margin-bottom:1rem;text-align:center;position:relative}
        .source-db{background-color:#e6f4ea;color:#1e8e3e;border:1px solid #a8d5b5}
        .source-google{background-color:#fff0e6;color:#d93025;border:1px solid #f5c2b3}
        .source-cache{background-color:#e8f0fe;color:#174ea6;border:1px solid #a9c5f5}
        .action-btn{width:100%;padding:10px;font-size:1rem;font-weight:700;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s;margin-top:1.5rem}
        #ai-search-btn{background-color:#f29900}
        #ai-search-btn:hover{background-color:#d18400}
        .compare-ai-btn{background-color:#34a853}
        .compare-ai-btn:hover{background-color:#1e8e3e}
        .delete-cache-btn{background:0 0;border:1px solid #d93025;color:#d93025;padding:4px 8px;font-size:.8rem;border-radius:4px;cursor:pointer;position:absolute;right:10px;top:50%;transform:translateY(-50%);transition:background-color .2s,color .2s}
        .delete-cache-btn:hover{background-color:#d93025;color:#fff}
        .loader{border:5px solid #f3f3f3;border-top:5px solid #1a73e8;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="app-container">
        <h1>ค้นหาสารก่อภูมิแพ้</h1>
        <a href="/list.html" style="display: block; text-align: center; margin-bottom: 1.5rem;">ดูรายการสารทั้งหมด →</a>
        <input type="text" id="search-box" placeholder="เริ่มพิมพ์เพื่อค้นหา...">
        <div id="result-container">
            <p style="text-align:center; color: #555;">ผลการค้นหาจะแสดงที่นี่...</p>
        </div>
    </div>

    <script>
        const searchBox = document.getElementById('search-box');
        const resultContainer = document.getElementById('result-container');
        let debounceTimer;

        const debounce = (func, delay) => {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const deleteCacheAndReset = async (queryToDelete) => {
            try {
                await fetch('/api/delete-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: queryToDelete })
                });
                alert(`ลบ Cache สำหรับ "${queryToDelete}" เรียบร้อยแล้ว`);
                searchBox.value = '';
                resultContainer.innerHTML = '<p style="text-align:center; color: #555;">กรุณาค้นหาอีกครั้ง</p>';
                searchBox.focus();
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการลบ Cache');
            }
        };

        const renderResult = (data, originalQuery, isComparison = false) => {
            let sourceClass = 'source-google';
            let deleteButtonHTML = '';
            let compareButtonHTML = '';

            if (data.source.includes('ฐานข้อมูลของเรา')) {
                sourceClass = 'source-db';
                if (!isComparison) {
                    compareButtonHTML = `<button class="action-btn compare-ai-btn" data-query="${originalQuery}">ค้นหาข้อมูลเปรียบเทียบจาก AI</button>`;
                }
            } else if (data.source.includes('Cache')) {
                sourceClass = 'source-cache';
                deleteButtonHTML = `<button class="delete-cache-btn" data-query="${originalQuery}">ลบ Cache</button>`;
            }
            
            return `
                <div class="result-block">
                    <div class="source-info ${sourceClass}">
                        ${deleteButtonHTML}
                        <strong>ที่มา:</strong> ${data.source}
                    </div>
                    <div class="result-item">
                        <h4>โอกาสแพ้</h4><p>${data.allergy_status}</p>
                        <h4>ชื่อจริง</h4><p>${data.name}</p>
                        <h4>ชื่อแฝง</h4><p>${data.aliases || '-'}</p>
                        <h4>หน้าที่</h4><p>${data.func || '-'}</p>
                        <h4>พบใน</h4><p>${data.products || '-'}</p>
                    </div>
                    ${compareButtonHTML}
                </div>
            `;
        };
        
       // --- แก้ไขฟังก์ชัน searchWithAI ---
        const searchWithAI = async (question, isForComparison = false) => {
            let targetContainer;
            if (isForComparison) {
                targetContainer = document.getElementById('ai-comparison-block');
                if (!targetContainer) {
                    targetContainer = document.createElement('div');
                    targetContainer.id = 'ai-comparison-block';
                    resultContainer.appendChild(targetContainer);
                }
            } else {
                resultContainer.innerHTML = '';
                targetContainer = resultContainer;
            }
            
            targetContainer.innerHTML = '<div class="loader"></div>';

            try {
                // --- ส่วนที่แก้ไข: เพิ่ม method, headers, body กลับเข้ามา ---
                const response = await fetch('/api/ask-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question })
                });
                // ----------------------------------------------------

                const data = await response.json();
                if (!response.ok) {
                    // ถ้าเกิด Error 500 จากฝั่ง Server, data.error จะมีข้อความ
                    throw new Error(data.error || 'เกิดข้อผิดพลาดในการสื่อสารกับ AI');
                }
                
                const finalData = { ...data, source: 'ผลการค้นหาที่ถูกบันทึกไว้ (Cache)', allergy_status: 'ข้อมูลนี้เป็นเพียงสิ่งที่เคยค้นหาและบันทึกไว้' };
                localStorage.setItem(question.toLowerCase().trim(), JSON.stringify(finalData));
                
                const finalHTML = renderResult(finalData, question, true);
                if(isForComparison) {
                    targetContainer.outerHTML = `<div id="ai-comparison-block">${finalHTML}</div>`;
                } else {
                    targetContainer.innerHTML = finalHTML;
                }

            } catch (error) {
                targetContainer.innerHTML = `<div class="result-block"><div class="source-info source-google">เกิดข้อผิดพลาด: ${error.message}</div></div>`;
            } finally {
                if (!isForComparison) searchBox.value = '';
                const compareBtn = document.querySelector('.compare-ai-btn');
                if(compareBtn) {
                    compareBtn.disabled = false;
                    compareBtn.textContent = 'อัปเดตข้อมูลเปรียบเทียบจาก AI';
                }
            }
        };

        const handleLiveSearch = async (question) => {
            if (question.trim().length < 2) {
                resultContainer.innerHTML = '<p style="text-align:center; color: #555;">กรุณาพิมพ์อย่างน้อย 2 ตัวอักษร...</p>';
                return;
            }
            
            resultContainer.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch('/api/live-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                const result = await response.json();

                if (result.found) {
                    resultContainer.innerHTML = renderResult(result.data, question, false);
                } else {
                    resultContainer.innerHTML = `
                        <div class="source-info source-google">
                            ไม่พบ "${question}" ในฐานข้อมูลและ Cache
                        </div>
                        <p style="text-align:center;">ต้องการค้นหาจากแหล่งข้อมูลภายนอกด้วย AI หรือไม่?</p>
                        <button class="action-btn" id="ai-search-btn">ค้นหาด้วย AI และบันทึกผล</button>
                    `;
                    document.getElementById('ai-search-btn').addEventListener('click', () => searchWithAI(question, false));
                }
            } catch (error) {
                 resultContainer.innerHTML = `<div class="source-info source-google">เกิดข้อผิดพลาด: ${error.message}</div>`;
            }
        };

        resultContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-cache-btn')) {
                const queryToDelete = event.target.dataset.query;
                if (queryToDelete && confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบ Cache ของ "${queryToDelete}"?`)) {
                    deleteCacheAndReset(queryToDelete);
                }
            }
            if (event.target.classList.contains('compare-ai-btn')) {
                const queryToCompare = event.target.dataset.query;
                event.target.disabled = true;
                event.target.textContent = 'กำลังอัปเดตข้อมูล...';
                searchWithAI(queryToCompare, true);
            }
        });

        searchBox.addEventListener('input', debounce((e) => handleLiveSearch(e.target.value), 300));
    </script>
</body>
</html>