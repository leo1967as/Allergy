<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Search สารก่อภูมิแพ้</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Sarabun',sans-serif;background-color:#f0f2f5;color:#333;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;padding-top:2rem;padding-bottom:2rem}
        #app-container{width:90%;max-width:650px;background-color:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        h1{color:#1a73e8;text-align:center;margin-bottom:1.5rem}
        #search-box{width:100%;padding:14px;font-size:1.1rem;border-radius:8px;border:2px solid #ccc;box-sizing:border-box;transition:border-color .3s}
        #search-box:focus{border-color:#1a73e8;outline:none}
        #result-container{margin-top:1.5rem;min-height:50px;line-height:1.7}
        .result-item h4{margin-top:1rem;margin-bottom:.5rem;color:#1a73e8;border-bottom:2px solid #e0e0e0;padding-bottom:.4rem}
        .result-item p{margin:0 0 .5rem .5rem}
        .source-info{font-size:.9rem;font-weight:700;padding:.5rem 1rem;border-radius:6px;margin-bottom:1rem;text-align:center}
        .source-db{background-color:#e6f4ea;color:#1e8e3e;border:1px solid #a8d5b5}
        .source-google{background-color:#fff0e6;color:#d93025;border:1px solid #f5c2b3}
        .source-cache{background-color:#e8f0fe;color:#174ea6;border:1px solid #a9c5f5} /* สีใหม่สำหรับ Cache */
        #ai-search-btn{width:100%;padding:12px;font-size:1.1rem;font-weight:700;color:#fff;background-color:#f29900;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s;margin-top:1rem}
        #ai-search-btn:hover{background-color:#d18400}
        .loader{border:5px solid #f3f3f3;border-top:5px solid #1a73e8;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="app-container">
        <h1>ค้นหาสารก่อภูมิแพ้</h1>
                <a href="list.html" style="display: block; text-align: center; margin-bottom: 1.5rem;">ดูรายการสารทั้งหมด →</a>

        <input type="text" id="search-box" placeholder="เริ่มพิมพ์เพื่อค้นหา...">
        <div id="result-container">
            <p style="text-align:center; color: #555;">ผลการค้นหาจะแสดงที่นี่...</p>
        </div>
    </div>

    <script>
        // --- โค้ด JavaScript ทั้งหมดเหมือนกับเวอร์ชัน Client-Side Cache ที่เราคุยกันล่าสุด ---
        // --- แต่มีการแก้ไข URL ใน fetch ให้เป็นแบบ Relative Path ---
        const searchBox = document.getElementById('search-box');
        const resultContainer = document.getElementById('result-container');
        let debounceTimer;

        const findInClientCache = (query) => {
            const cachedItem = localStorage.getItem(query.toLowerCase().trim());
            return cachedItem ? JSON.parse(cachedItem) : null;
        };

        const saveToClientCache = (query, data) => {
            const dataToCache = { ...data, source: 'ผลการค้นหาที่ถูกบันทึกไว้ (Cache)', allergy_status: 'ข้อมูลนี้เป็นเพียงสิ่งที่เคยค้นหาและบันทึกไว้' };
            localStorage.setItem(query.toLowerCase().trim(), JSON.stringify(dataToCache));
        };

        const debounce = (func, delay) => {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        };

        const renderResult = (data) => {
            let sourceClass = 'source-google';
            if (data.source.includes('ฐานข้อมูลของเรา')) sourceClass = 'source-db';
            else if (data.source.includes('Cache')) sourceClass = 'source-cache';
            return `...`; // โค้ดส่วน render เหมือนเดิม
        };
        
        const searchWithAI = async (question) => {
            resultContainer.innerHTML = '<div class="loader"></div>';
            try {
                // --- แก้ไข URL ---
                const response = await fetch('/api/ask-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'เกิดข้อผิดพลาด');
                
                saveToClientCache(question, data);
                const finalData = findInClientCache(question);
                resultContainer.innerHTML = renderResult(finalData);

            } catch (error) {
                resultContainer.innerHTML = `<div class="source-info source-google">เกิดข้อผิดพลาด: ${error.message}</div>`;
            } finally {
                searchBox.value = '';
            }
        };

        const handleLiveSearch = async (question) => {
            if (question.trim().length < 2) {
                resultContainer.innerHTML = '<p style="text-align:center; color: #555;">กรุณาพิมพ์อย่างน้อย 2 ตัวอักษร...</p>';
                return;
            }

            const cacheResult = findInClientCache(question);
            if (cacheResult) {
                resultContainer.innerHTML = renderResult(cacheResult);
                return;
            }

            resultContainer.innerHTML = '<div class="loader"></div>';
            try {
                // --- แก้ไข URL ---
                const response = await fetch('/api/live-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                const result = await response.json();

                if (result.found) {
                    resultContainer.innerHTML = renderResult(result.data);
                } else {
                    resultContainer.innerHTML = `...`; // โค้ดแสดงปุ่มค้นหา AI เหมือนเดิม
                    document.getElementById('ai-search-btn').addEventListener('click', () => searchWithAI(question));
                }
            } catch (error) {
                 resultContainer.innerHTML = `<div class="source-info source-google">เกิดข้อผิดพลาด: ${error.message}</div>`;
            }
        };

        searchBox.addEventListener('input', debounce((e) => handleLiveSearch(e.target.value), 300));
    </script>
</body>
</html>